title: '如何做详细设计之重构'
date: 2015-01-01 22:58:51
categories:
	- detailed design
tags:
	- Design pattern
	- java
	- detailed design
---

今天是2015年1月1日，又是一个新的开始。今天我们来讨论如何做详细设计中的重构。作为一名软件开发工程师，可能大部分都知道重构这个概念，相信也有很多人有看过Martin Flower的重构这本书，了解一些重构技巧。很多人理解的重构，就是代码结构基本上要重新设计，大部分代码需要重写，所以在实际的工作中，看到项目中的代码总是抱怨，想着什么时候能有一段时间来重构一次就好了，其实我不认为这是重构，这叫推倒重来。本文主要讲的是如何演变式的重构，每一次需求的变动重新审视目前的详细设计，并修正详细设计中的不足。从而保证代码的可持续的发展。我们将分为需求变了和如何收拾烂摊子来讨论今天的内容。本篇不涉及一些重构技巧，因为重构技巧非常多，而且不同的业务场景解决方式不尽相同。如果你想了解重构的技巧建议阅读Martin Flower大师的重构这本书。<!--more-->
####需求又变了！
在这一系列中我一直在讲只要你在写代码就在做详细设计，像我这样工作了一两年的菜鸟也能做详细设计。可能你会想经验那么少，怎么能够做出优秀的设计来应对需求的不断变化呢？当然我不能做到能够面对需求的变化并且一成不变的设计。我能做到的是在需求变化时，我及时调整我的详细设计，来适用新的业务。每次产品经理给我们提出一个需求时，我们都会讲“怎么又变了！”“昨天找你确认还是怎么怎么样的！”“邮件上不是说的是这样的嘛？”，所以对需求的“变”我们已经习以为常，产品需求不变的就是变。面对这种需求的不断变化，相信即使你是Martin Flower一样的大师，你也无法做出可以支撑你整个产品周期的详细设计。
那么什么时候需要重新思考我们的详细设计呢？
以下是我想到的三种场景：
1、业务增加不符合之前提出的假设时。比如我去年遇到的一个场景，当时做一个单词朗读评分的功能，当时用到了公司牛b的评测引擎。该评测引擎分为几种模式，单词评测，句子评测等。刚开始产品设计时，只需要支持单个单词的评测，当时完成了第一个版本，就是把引擎返回的数据直接显示在界面上。在第二个版本时，需要支持词组评测，词组和单词的评测引擎不同。需要两次请求评测引擎，显然之前第一个版本的设计仅支持一次请求的评测。在变成两次后，就需要对第一次返回的数据进行缓存，和第二次返回的一起显示到界面。当时就适时的进行一次设计重构增加一个结果缓存类，来统一管理引擎返回的数据。具有初始化、查询、回滚等功能（当时的需求涉及重读，异常退出等，远比只显示复杂。显示只是其中之一）。仔细思考以下自己工作的经历，这种示例比比皆是。
2、业务频繁修改，程序显得很被动时。可能我们经常会遇到这种情况，业务频繁修改，每次都要修改功能类似的很多地方的代码。这时就需要从详细设计上考虑当前设计是否合理。在上一篇理解业务的本质的抽象一节我举的一个例子就是属于这类情况。
3、业务中的某些概念发生变化。比如我们目前的做的产品中，刚开始没有考试的概念，只有试卷的概念。后来增加了考试的概念，一次考试指一个学校一个年级多个学科的概念，这时我们就需要重新考虑我们之前的所有关于试卷的详细设计是否还满足当前的需求。当然马上又要增加联考，考试的概念又发生变化，这也是我们马上要解决的问题。
当然可能还会有很多场景。其实每次业务的变化，都需要审视一下我们的当前详细设计是否满足新的业务变化！以上讨论的时在详细设计阶段的何时需要重构，在重构那本书里，代码的坏味道一章讲解了什么样的代码需要重构。
####烂摊子怎么办？？
以上一节其实讲的面对新的需求变化时，我们也要以变应变，而不是以不变应万变。本节讨论的是，在你接手了别人的工作时，遇到了烂摊子怎么办？当然你也可能接手一位非常优秀的程序员的代码，那时就可以仔细的研究一下他的设计思想，学习一下了。当然这是运气非常好的时候。因为每一位程序员都有着自己的思路，大部分程序员都是接手后不理解原作者的思路，总觉得这也不好那也不好。即使抱怨，但是事已经摊到头上了，还是要解决的，首先需要理解原作者的思路，理解系统中的每个类的意图，处理的业务是什么。采用逐步改进的方式，重构现有代码。
1、在新增需求时或者以前发生变更时，考虑现有设计是否满足，如果不满足，改进和新需求相关的设计。可以根据上一节的两种情况来审视详细设计。
2、在充分理解了系统业务，并且对现有代码理解后，经过领导同意后，进行部分代码重构。
总之，一般情况下，改进现有的代码经常是长期的，逐步的修改。
####详细设计的进化
一个软件从无到有，是一个发展过程，从有到优有是一个过程。就像大自然的生物一样，大自然的生物需要根据环境的变化以及其他因素的影响不断的进化，以适应新的变化。所以一款好的软件也是在不断的进化的。我们的详细设计也是需要根据需求的进化而不断的重构才能适应新的需求。

本篇内容是在平常工作中的实践思考与总结。如有不妥之处，欢迎讨论。
